name: Make sure hx-multianim builds

on:
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Haxe
      uses: krdlab/setup-haxe@v1
      with:
        haxe-version: '4.3.6'

    - name: Setup Lix
      uses: lix-pm/setup-lix@5d98ddc5d00ee5ebf9bd3095dc36b1c9fb50a98f # latest version

    - name: Cache Lix dependencies
      uses: actions/cache@v4
      with:
        path: ~/.lix
        key: ${{ runner.os }}-lix-${{ hashFiles('**/haxe_libraries/*.hxml') }}
        restore-keys: |
          ${{ runner.os }}-lix-

    - name: Install dependencies
      run: lix download

    - name: Create build directory
      run: mkdir -p build

    - name: Build library for hashlink
      run: |
        haxe hx-multianim.hxml -hl build/hl-manim.hl -D message.reporting=pretty -D resourcesPath=playground/res

    - name: Build library for javascript
      run: |
        haxe hx-multianim.hxml -js build/js-manim.js -D message.reporting=pretty -D resourcesPath=playground/res

    - name: Verify build output
      run: |
        test -f build/hl-manim.hl || (echo "ERROR: build/hl-manim.hl not found" && exit 1)
        test -f build/js-manim.js || (echo "ERROR: build/js-manim.js not found" && exit 1)
        echo "Build artifacts verified successfully"
