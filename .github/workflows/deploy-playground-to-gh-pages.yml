name: Deploy playground to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: playground/package-lock.json

    - name: Install npm dependencies
      working-directory: playground
      run: npm ci

    - name: Setup Haxe
      uses: krdlab/setup-haxe@v1
      with:
        haxe-version: '4.3.6'

    - name: Setup Lix
      uses: lix-pm/setup-lix@5d98ddc5d00ee5ebf9bd3095dc36b1c9fb50a98f # latest version

    - name: Cache Lix dependencies
      uses: actions/cache@v4
      with:
        path: ~/.lix
        key: ${{ runner.os }}-lix-${{ hashFiles('**/haxe_libraries/*.hxml') }}
        restore-keys: |
          ${{ runner.os }}-lix-

    - name: Install Lix dependencies
      working-directory: playground
      run: lix download

    - name: Build for GitHub Pages
      working-directory: playground
      run: npm run full:build

    - name: Verify build output
      working-directory: playground
      run: |
        test -f public/playground.js || (echo "ERROR: playground.js not found" && exit 1)
        test -d dist || (echo "ERROR: dist directory not found" && exit 1)
        echo "Build artifacts verified successfully"

    # Deploy main branch to root of gh-pages
    - name: Deploy to GitHub Pages (main)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./playground/dist
        publish_branch: gh-pages

    # Deploy PR to /pr-<number>/ subdirectory for preview
    - name: Deploy PR Preview
      if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./playground/dist
        publish_branch: gh-pages
        destination_dir: pr-${{ github.event.pull_request.number }}

    - name: Comment PR with preview URL
      if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const repoOwner = context.repo.owner;
          const repoName = context.repo.repo;
          const previewUrl = `https://${repoOwner}.github.io/${repoName}/pr-${prNumber}/`;

          // Check if we already commented
          const { data: comments } = await github.rest.issues.listComments({
            owner: repoOwner,
            repo: repoName,
            issue_number: prNumber,
          });

          const botComment = comments.find(comment =>
            comment.user.type === 'Bot' &&
            comment.body.includes('Preview deployment')
          );

          const body = [
            '## Preview deployment',
            '',
            'Your changes have been deployed to a preview environment:',
            '',
            `**Preview URL:** ${previewUrl}`,
            '',
            'This preview will be updated with each new commit to this PR.'
          ].join('\n');

          if (botComment) {
            await github.rest.issues.updateComment({
              owner: repoOwner,
              repo: repoName,
              comment_id: botComment.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: repoOwner,
              repo: repoName,
              issue_number: prNumber,
              body: body
            });
          }
