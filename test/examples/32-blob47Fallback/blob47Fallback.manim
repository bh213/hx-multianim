version: 0.3

// =============================================================================
// BLOB47 FALLBACK TEST - Tests blob47 with partial tileset (uses fallback)
// =============================================================================
// Uses Forgotten Plains tileset with blob47 format.
// Only a few tiles are defined - missing tiles use automatic fallback.
// =============================================================================

// Demo autotile for comparison
#blob47Demo autotile {
    format: blob47
    tileSize: 8
    demo: 0x66AA44, 0x886644    // green edges (grass border), brown fill (dirt center)
}

// Blob47 autotile using Forgotten Plains tileset
// Only basic tiles defined - corners will fall back to simpler tiles
// Tileset: Minifantasy - Forgotten Plains by Krishna Palacio
// Grass tiles at region [56, 24, 24, 40] = 3x5 grid of 8x8 tiles
#blob47Grass autotile {
    format: blob47
    tileSize: 8
    file: "Tileset/Minifantasy_ForgottenPlainsTiles.png"
    region: [56, 24, 24, 40]
    allowPartialMapping: true
    // Mapping from blob47 index to region tile index using source:target syntax
    // Blob47: tile index = which neighbors ARE present (grass connects there)
    // Region: tile name = which side is the EDGE (border/no neighbor)
    // So blob47 "has N neighbor" needs region "S edge" (connects north, border south)
    mapping: [
        0:4,    // 0: isolated -> center tile (best visual)
        1:7,    // 1: has N neighbor -> S edge (connects up, border down)
        2:3,    // 2: has E neighbor -> W edge (connects right, border left)
        3:6,    // 3: has N+E -> SW outer corner
        4:6,    // 4: has N+NE+E -> SW outer (same, no distinct corner tile)
        5:1,    // 5: has S neighbor -> N edge (connects down, border up)
        6:4,    // 6: has N+S -> center (vertical strip)
        7:0,    // 7: has E+S -> NW outer corner
        8:3,    // 8: has N+E+S -> W edge (open west)
        9:3,    // 9: has N+NE+E+S -> W edge
        10:0,   // 10: has E+SE+S -> NW outer
        11:3,   // 11: has N+E+SE+S -> W edge
        12:3,   // 12: has N+NE+E+SE+S -> W edge
        13:5,   // 13: has W neighbor -> E edge (connects left, border right)
        14:8,   // 14: has N+W -> SE outer corner
        15:4,   // 15: has E+W -> center (horizontal strip)
        16:7,   // 16: has N+E+W -> S edge (open south)
        17:7,   // 17: has N+NE+E+W -> S edge
        18:2,   // 18: has S+W -> NE outer corner
        19:5,   // 19: has N+S+W -> E edge (open east)
        20:1,   // 20: has E+S+W -> N edge (open north)
        21:4    // 21: has N+E+S+W -> center
        // Tiles 22-46 not mapped - will use fallback!
    ]
}

// Visual demo - shows all 47 tiles with demo + tileset comparison, then map
#blob47Fallback programmable() {
    pos: 0, 0
    grid: 1280, 720

    @alpha(0.1) bitmap(generated(color(1280, 720, black)));

    // Show all 47 tiles: demo shape (top) vs tileset with fallback (bottom)
    // 8x8 tiles scaled 2x = 16x16 display, 20 tiles per row, 36px spacing (16+2+16+2)
    text(f3x5, "Top: demo shape, Bottom: tileset (fallback for 22-46)", 0x888888, left):10,10

    // Row labels
    text(f3x5, "0-19:", 0x666666, right):28,24
    text(f3x5, "20-39:", 0x666666, right):28,62
    text(f3x5, "40-46:", 0x666666, right):28,100

    // Display all 47 tiles in rows of 20, scaled 2x
    repeatable($i, range(0, 47)) {
        point {
            pos: 35 + ($i % 20) * 20, 22 + ($i div 20) * 38
            // Demo tile (top) - shows expected shape, scaled 2x
            @scale(2) bitmap(generated(autotile("blob47Demo", $i))):0,0
            // Tileset tile (bottom) - uses fallback for tiles 22-46, scaled 2x
            @scale(2) bitmap(generated(autotile("blob47Grass", $i))):0,18
        }
    }

    // Map section
    text(f3x5, "Terrain Map - Demo (left) vs Tileset with fallback (right)", 0x888888, left):10,142

    // Map backgrounds positioned for test code
    bitmap(generated(color(136, 104, black))):10,152
    bitmap(generated(color(136, 104, black))):160,152
}
